<link rel="import" href="../environments/environment.html">
<link rel="import" href="../assets/libs/polymer/polymer.html">
<link rel="import" href="../assets/libs/app-route/app-route.html">
<link rel="import" href="../assets/libs/app-route/app-location.html">
<link rel="import" href="../assets/libs/iron-pages/iron-pages.html">
<link rel="import" href="../assets/libs/iron-ajax/iron-ajax.html">
<link rel="import" href="home/portfolio-home.html">

<dom-module id="portfolio-app">

  <template>

    <style>

      :host {
          display: flex;
          flex-direction: column;
      }

      header, iron-pages {
          padding: 1.6rem;
      }

    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{pageRouter}}" tail="{{categoryRoute}}"></app-route>
    <app-route route="{{categoryRoute}}" pattern="/:category" data="{{categoryRouter}}" tail="{{postRoute}}"></app-route>
    <app-route route="{{postRoute}}" pattern="/:post" data="{{postRouter}}"></app-route>

    <iron-ajax id="category-request" url="[[requestUrl]]" handle-as="json" on-response="onCategoryResponse" debounce-duration="300"></iron-ajax>

    <header>
      <a href="/">Home</a>
      <a href="/list/graphic-design">Graphic Design</a>
      <a href="/list/photography">Photography</a>
      <a href="/about">About</a>
    </header>

    <iron-pages selected="[[page]]" attr-for-selected="selected" selected-attribute="visible" fallback-selection="404" on-iron-select="listenerIronSelect">
      <portfolio-home
        selected="home"></portfolio-home>

      <portfolio-about
        selected="about"></portfolio-about>

      <portfolio-list
        selected="list"
        category="[[category]]"></portfolio-list>

      <portfolio-post
        selected="post"
        post="[[post]]"></portfolio-post>

      <portfolio-404
        selected="404"></portfolio-404>
    </iron-pages>

  </template>

  <script>

    Polymer({

      is: 'portfolio-app',

      behaviors: [

      ],

      properties: {
        page: {
          type: String,
          value: () => { return {}; },
        },
        category: {
          type: Object,
          value: () => { return ``; },
        },
        post: {
          type: Object,
          value: () => { return ``; },
        },
        requestUrl: {
          type: String,
          value: () => { return ``; },
          computed: `computeRequestURL(categoryRouter.category)`,
        }
      },

      observers: [
        'logger(pageRouter.page)',
        'observerRoute(route)',
        'observerCategory(category)'
      ],

      listeners: {

      },

      ready() {

      },

      attached() {

      },

      detached() {

      },


      /* OBSERVERS */
      logger(x) {
        console.log(`logger: `, x);
      },

      observerRoute(route) {
        if (this.pageRouter.page === `list` && !this.categoryRouter
            || this.pageRouter.page === `post` && !this.postRouter) {
          this.set(`page`, `404`);
        } else {
          this.page = (this.pageRouter.page === '') ? 'home' : this.pageRouter.page;
        }

        if (this.categoryRouter) {
          // console.log(`request`);
          this.doRequest();
        }

      },

      observerCategory(category) {
        console.log(`observerCategory: `, category);

        console.log(this.pageRouter.page);

        // if (this.pageRouter.page === `post`) {
        //   console.log(`get post`);
        //   this.getPost(this.category);
        // }
      },

      /* LISTENERS */
      listenerIronSelect(event) {
        const name = event.target.selected;
        const importHref = `${name}/portfolio-${name}.html`;
        this.importHref(this.resolveUrl(importHref), null, null, true);
      },

      /* FUNCTIONS */
      computeRequestURL(category) {
        return `../../assets/data/${category}.json`;
      },

      doRequest() {
        this.$$(`#category-request`).generateRequest();
      },

      onCategoryResponse(data) {
        this.set(`category`, data.detail.response);
      },

      getPost(category) {
        for (let i in category.content) {
          if (category.content[i].id === this.postRouter.post)
            this.set(`post`, category.content[i])
            console.log(this.post);
        }
      },

    });

  </script>

</dom-module>